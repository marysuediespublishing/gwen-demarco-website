---
import Layout from '../layouts/Layout.astro';
import { SITE_TITLE } from '../consts';
import { getCollection } from 'astro:content';

// Get all characters, books, series, and species
const allCharacters = await getCollection('characters');
const allBooks = await getCollection('books');
const allSeries = (await getCollection('series')).map(series => ({
	...series,
	slug: series.id
}));
const allSpecies = await getCollection('species');

// Create a book slug -> series slug mapping
const bookToSeriesMap = new Map<string, string>();
allBooks.forEach(book => {
	if (book.data.series) {
		// Normalize the book's series field for comparison
		const bookSeriesNormalized = book.data.series.toLowerCase().replace(/&/g, 'and').replace(/\s+/g, '-');

		// Find matching series by title, slug, or normalized comparison
		const matchingSeries = allSeries.find(s => {
			// Direct matches
			if (s.data.title === book.data.series) return true;
			if (s.slug === book.data.series) return true;

			// Normalized slug comparison (book series "Auras & Embers" -> "auras-and-embers" === series slug "auras-and-embers")
			if (s.slug === bookSeriesNormalized) return true;

			// Normalized title comparison (handles cases with "Series" suffix)
			const seriesTitleNormalized = s.data.title.toLowerCase().replace(/&/g, 'and').replace(/\s+/g, '-');
			if (seriesTitleNormalized === bookSeriesNormalized) return true;

			// Also check if the series title starts with the book's series value
			if (s.data.title.toLowerCase().startsWith(book.data.series.toLowerCase())) return true;

			return false;
		});
		if (matchingSeries) {
			bookToSeriesMap.set(book.id, matchingSeries.slug);
		}
	}
});

// Add appearance count and series info for each character
const charactersWithStats = allCharacters.map(character => {
	// Count main book appearances
	const mainBookCount = character.data.books?.length || 0;

	// Count cameo appearances
	const cameoCount = character.data.cameos?.length || 0;

	// Get species info if available
	const speciesInfo = character.data.species
		? allSpecies.find(s => s.id === character.data.species)
		: null;

	// Determine series from first book in the character's books array
	let seriesSlug: string | null = null;
	if (character.data.books && character.data.books.length > 0) {
		seriesSlug = bookToSeriesMap.get(character.data.books[0]) || null;
	}

	return {
		...character,
		mainBookCount,
		cameoCount,
		totalAppearances: mainBookCount + cameoCount,
		speciesInfo,
		seriesSlug,
	};
});

// Group characters by series
const charactersBySeries = new Map<string, typeof charactersWithStats>();
const otherCharacters: typeof charactersWithStats = [];

charactersWithStats.forEach(character => {
	if (character.seriesSlug) {
		if (!charactersBySeries.has(character.seriesSlug)) {
			charactersBySeries.set(character.seriesSlug, []);
		}
		charactersBySeries.get(character.seriesSlug)!.push(character);
	} else {
		otherCharacters.push(character);
	}
});

// Sort characters within each group by name
charactersBySeries.forEach((characters, key) => {
	characters.sort((a, b) => a.data.name.localeCompare(b.data.name));
});
otherCharacters.sort((a, b) => a.data.name.localeCompare(b.data.name));

// Sort series: featured first, then by start date (to match /series page order)
const sortedSeriesKeys = Array.from(charactersBySeries.keys()).sort((aKey, bKey) => {
	const aSeries = allSeries.find(s => s.slug === aKey);
	const bSeries = allSeries.find(s => s.slug === bKey);
	if (!aSeries || !bSeries) return 0;

	if (aSeries.data.featured && !bSeries.data.featured) return -1;
	if (!aSeries.data.featured && bSeries.data.featured) return 1;
	return new Date(bSeries.data.startDate || 0).getTime() - new Date(aSeries.data.startDate || 0).getTime();
});

// Create sorted series groups with series data
const seriesGroups = sortedSeriesKeys.map(slug => {
	const series = allSeries.find(s => s.slug === slug)!;
	const characters = charactersBySeries.get(slug)!;
	return { series, characters };
});
---

<Layout title={`Characters - ${SITE_TITLE}`} description="Meet the unforgettable characters from Gwen DeMarco's paranormal romance novels. From snarky heroines to grumpy heroes, explore their stories.">
	<main id="main-content" class="relative">
		<!-- Hero Section -->
		<section class="relative py-16 bg-gradient-night overflow-hidden">
			<!-- Background fog effect -->
			<div class="absolute inset-0 bg-gradient-fog opacity-30"></div>
			<div class="absolute inset-0 bg-gradient-to-t from-shadow-black/60 to-transparent"></div>

			<div class="container mx-auto px-4 relative z-10">
				<div class="max-w-5xl mx-auto text-center">
					<h1 class="text-4xl md:text-6xl font-primary font-bold text-bone-white mb-6">
						<span class="bg-gradient-to-r from-mystic-violet via-ember-orange to-mystic-teal bg-clip-text text-transparent">
							Characters
						</span>
					</h1>
					<p class="text-xl md:text-2xl text-ember-orange font-medium mb-4">
						Meet the faces of urban fantasy
					</p>
					<p class="text-lg text-moon-silver/90 max-w-3xl mx-auto leading-relaxed">
						From snarky heroines to grumpy heroes, explore the unforgettable characters who bring these supernatural worlds to life. Each one has their own story, secrets, and reasons to keep reading.
					</p>
				</div>
			</div>
		</section>

		<!-- Characters Grouped by Series -->
		{seriesGroups.map((group, index) => (
			<section class={`py-16 ${index % 2 === 0 ? 'bg-dark-surface' : 'bg-bg-secondary'}`}>
				<div class="container mx-auto px-4">
					<div class="max-w-7xl mx-auto">
						<!-- Series Header -->
						<div class="mb-10">
							<div class="flex flex-wrap items-center gap-4 mb-3">
								<a href={`/series/${group.series.slug}`} class="group flex items-center gap-3 hover:text-ember-orange transition-colors">
									<h2 class="text-3xl md:text-4xl font-primary font-bold text-bone-white group-hover:text-ember-orange transition-colors">
										{group.series.data.title}
									</h2>
									<svg class="w-6 h-6 text-mystic-teal group-hover:text-ember-orange transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
									</svg>
								</a>
								{group.series.data.completionStatus === 'complete' && (
									<span class="badge badge-primary uppercase tracking-wide">
										Complete
									</span>
								)}
								{group.series.data.completionStatus === 'ongoing' && (
									<span class="badge badge-secondary uppercase tracking-wide">
										Ongoing
									</span>
								)}
							</div>
							<p class="text-fog-gray text-lg">
								{group.characters.length} {group.characters.length === 1 ? 'character' : 'characters'} from this series
							</p>
						</div>

						<!-- Character Cards Grid -->
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
							{group.characters.map((character) => (
								<a
									href={`/characters/${character.id}`}
									class="group block bg-midnight-purple/50 rounded-xl overflow-hidden shadow-lg hover:shadow-mystic transition-all duration-300 hover:-translate-y-2 border border-mystic-violet/20 hover:border-mystic-violet/50"
								>
									<!-- Character Image -->
									<div class="relative aspect-[4/3] overflow-hidden">
										{character.data.image ? (
											<img
												src={character.data.image}
												alt={`${character.data.name} character artwork`}
												class="w-full h-full object-cover object-top group-hover:scale-110 transition-transform duration-300"
											/>
										) : (
											<div class="w-full h-full bg-gradient-to-br from-mystic-violet/40 to-midnight-purple flex items-center justify-center">
												<div class="text-center text-moon-silver">
													<div class="text-6xl mb-4 opacity-80">ðŸ‘¤</div>
													<div class="text-lg font-bold text-bone-white">{character.data.name}</div>
												</div>
											</div>
										)}
										<!-- Overlay -->
										<div class="absolute inset-0 bg-gradient-to-t from-shadow-black/60 to-transparent"></div>

										<!-- Species Badge -->
										{character.speciesInfo && (
											<div class="absolute top-3 right-3 px-3 py-1 bg-mystic-violet/80 text-bone-white text-xs font-medium rounded-full backdrop-blur-sm">
												{character.speciesInfo.data.name}
											</div>
										)}
									</div>

									<!-- Character Info -->
									<div class="p-6">
										<h3 class="text-2xl font-primary font-bold text-bone-white mb-3 group-hover:text-ember-orange transition-colors">
											{character.data.name}
										</h3>

										{character.data.description && (
											<p class="text-moon-silver/80 text-sm leading-relaxed mb-4 line-clamp-3">
												{character.data.description}
											</p>
										)}

										<!-- Stats -->
										<div class="flex items-center justify-between text-sm text-fog-gray">
											<div class="flex items-center space-x-4">
												{character.mainBookCount > 0 && (
													<span class="flex items-center space-x-1">
														<svg class="w-4 h-4 text-ember-orange" fill="currentColor" viewBox="0 0 20 20">
															<path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V4.804z"></path>
														</svg>
														<span>{character.mainBookCount} {character.mainBookCount === 1 ? 'book' : 'books'}</span>
													</span>
												)}

												{character.cameoCount > 0 && (
													<span class="flex items-center space-x-1">
														<svg class="w-4 h-4 text-mystic-teal" fill="currentColor" viewBox="0 0 20 20">
															<path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
															<path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
														</svg>
														<span>{character.cameoCount} {character.cameoCount === 1 ? 'cameo' : 'cameos'}</span>
													</span>
												)}
											</div>

											<div class="text-mystic-teal font-medium group-hover:text-ember-orange transition-colors">
												Learn More &rarr;
											</div>
										</div>
									</div>
								</a>
							))}
						</div>
					</div>
				</div>
			</section>
		))}

		<!-- Other Characters (no series assigned) -->
		{otherCharacters.length > 0 && (
			<section class={`py-16 ${seriesGroups.length % 2 === 0 ? 'bg-dark-surface' : 'bg-bg-secondary'}`}>
				<div class="container mx-auto px-4">
					<div class="max-w-7xl mx-auto">
						<!-- Section Header -->
						<div class="mb-10">
							<h2 class="text-3xl md:text-4xl font-primary font-bold text-bone-white mb-3">
								Other Characters
							</h2>
							<p class="text-fog-gray text-lg">
								{otherCharacters.length} {otherCharacters.length === 1 ? 'character' : 'characters'}
							</p>
						</div>

						<!-- Character Cards Grid -->
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
							{otherCharacters.map((character) => (
								<a
									href={`/characters/${character.id}`}
									class="group block bg-midnight-purple/50 rounded-xl overflow-hidden shadow-lg hover:shadow-mystic transition-all duration-300 hover:-translate-y-2 border border-mystic-violet/20 hover:border-mystic-violet/50"
								>
									<!-- Character Image -->
									<div class="relative aspect-[4/3] overflow-hidden">
										{character.data.image ? (
											<img
												src={character.data.image}
												alt={`${character.data.name} character artwork`}
												class="w-full h-full object-cover object-top group-hover:scale-110 transition-transform duration-300"
											/>
										) : (
											<div class="w-full h-full bg-gradient-to-br from-mystic-violet/40 to-midnight-purple flex items-center justify-center">
												<div class="text-center text-moon-silver">
													<div class="text-6xl mb-4 opacity-80">ðŸ‘¤</div>
													<div class="text-lg font-bold text-bone-white">{character.data.name}</div>
												</div>
											</div>
										)}
										<!-- Overlay -->
										<div class="absolute inset-0 bg-gradient-to-t from-shadow-black/60 to-transparent"></div>

										<!-- Species Badge -->
										{character.speciesInfo && (
											<div class="absolute top-3 right-3 px-3 py-1 bg-mystic-violet/80 text-bone-white text-xs font-medium rounded-full backdrop-blur-sm">
												{character.speciesInfo.data.name}
											</div>
										)}
									</div>

									<!-- Character Info -->
									<div class="p-6">
										<h3 class="text-2xl font-primary font-bold text-bone-white mb-3 group-hover:text-ember-orange transition-colors">
											{character.data.name}
										</h3>

										{character.data.description && (
											<p class="text-moon-silver/80 text-sm leading-relaxed mb-4 line-clamp-3">
												{character.data.description}
											</p>
										)}

										<!-- Stats -->
										<div class="flex items-center justify-between text-sm text-fog-gray">
											<div class="flex items-center space-x-4">
												{character.mainBookCount > 0 && (
													<span class="flex items-center space-x-1">
														<svg class="w-4 h-4 text-ember-orange" fill="currentColor" viewBox="0 0 20 20">
															<path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V4.804z"></path>
														</svg>
														<span>{character.mainBookCount} {character.mainBookCount === 1 ? 'book' : 'books'}</span>
													</span>
												)}

												{character.cameoCount > 0 && (
													<span class="flex items-center space-x-1">
														<svg class="w-4 h-4 text-mystic-teal" fill="currentColor" viewBox="0 0 20 20">
															<path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
															<path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
														</svg>
														<span>{character.cameoCount} {character.cameoCount === 1 ? 'cameo' : 'cameos'}</span>
													</span>
												)}
											</div>

											<div class="text-mystic-teal font-medium group-hover:text-ember-orange transition-colors">
												Learn More &rarr;
											</div>
										</div>
									</div>
								</a>
							))}
						</div>
					</div>
				</div>
			</section>
		)}

		<!-- Empty State -->
		{seriesGroups.length === 0 && otherCharacters.length === 0 && (
			<section class="py-16 bg-dark-surface">
				<div class="container mx-auto px-4">
					<div class="max-w-7xl mx-auto">
						<div class="text-center py-16">
							<div class="text-6xl mb-4">ðŸ‘¤</div>
							<h3 class="text-2xl font-bold text-bone-white mb-2">No Characters Found</h3>
							<p class="text-fog-gray">Character profiles are being added soon.</p>
						</div>
					</div>
				</div>
			</section>
		)}

		<!-- Browse More CTA -->
		<section class="py-16 bg-gradient-to-r from-midnight-purple via-shadow-black to-midnight-purple">
			<div class="container mx-auto px-4 text-center">
				<div class="max-w-3xl mx-auto space-y-8">
					<h2 class="text-3xl md:text-4xl font-primary font-bold text-bone-white">
						Discover Their Stories
					</h2>
					<p class="text-lg text-moon-silver/90">
						Follow these unforgettable characters through their adventures in Gwen DeMarco's paranormal romance novels
					</p>
					<div class="flex flex-col sm:flex-row gap-4 justify-center">
						<a href="/series" class="btn btn-primary btn-lg">
							Browse Series
						</a>
						<a href="/books" class="btn btn-outline btn-lg">
							View All Books
						</a>
					</div>
				</div>
			</div>
		</section>
	</main>
</Layout>

<style>
	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
