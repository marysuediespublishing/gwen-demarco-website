---
import Layout from '../layouts/Layout.astro';
import { SITE_TITLE } from '../consts';
import { getCollection } from 'astro:content';

// Get all series and add slug property
const allSeries = (await getCollection('series')).map(series => ({
	...series,
	slug: series.id
}));

// Get all books for each series
const allBooks = (await getCollection('books')).map(book => ({
	...book,
	slug: book.id
}));

// Function to convert species slugs to proper display names
const formatSpeciesName = (slug: string): string => {
	const speciesMap: Record<string, string> = {
		'shifters': 'Shifters',
		'ogres': 'Ogres',
		'vampires': 'Vampires',
		'fae': 'Fae',
		'auramancers': 'Auramancers',
		'humans': 'Humans',
		'hyvas': 'Hyvas',
		'bennu-shifters': 'Bennu Shifters'
	};

	if (speciesMap[slug]) {
		return speciesMap[slug];
	}

	// Convert kebab-case to title case
	return slug.split('-').map(word =>
		word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
	).join(' ');
};

// Group books by series
const seriesWithBooks = allSeries.map(series => {
	const seriesBooks = allBooks.filter(book => {
		// Match by series title or slug
		const bookSeries = book.data.series;
		return bookSeries === series.data.title ||
			   bookSeries === series.slug ||
			   bookSeries?.toLowerCase().replace(/\s+/g, '-') === series.slug;
	}).sort((a, b) => (a.data.seriesOrder || 999) - (b.data.seriesOrder || 999));
	return {
		...series,
		books: seriesBooks
	};
});

// Sort series: featured first, then by start date
const sortedSeries = seriesWithBooks.sort((a, b) => {
	if (a.data.featured && !b.data.featured) return -1;
	if (!a.data.featured && b.data.featured) return 1;
	return new Date(b.data.startDate || 0).getTime() - new Date(a.data.startDate || 0).getTime();
});
---

<Layout title={`Series - ${SITE_TITLE}`} description="Explore Gwen DeMarco's paranormal romance and urban fantasy series. Interconnected worlds with shifters, fae, vampires, and found family.">
	<main id="main-content" class="relative">
		<!-- Hero Section -->
		<section class="relative py-16 bg-gradient-night overflow-hidden">
			<!-- Background fog effect -->
			<div class="absolute inset-0 bg-gradient-fog opacity-30"></div>
			<div class="absolute inset-0 bg-gradient-to-t from-shadow-black/60 to-transparent"></div>

			<div class="container mx-auto px-4 relative z-10">
				<div class="max-w-5xl mx-auto text-center">
					<h1 class="text-4xl md:text-6xl font-primary font-bold text-bone-white mb-6">
						<span class="bg-gradient-to-r from-mystic-violet via-ember-orange to-mystic-teal bg-clip-text text-transparent">
							Book Series
						</span>
					</h1>
					<p class="text-xl md:text-2xl text-ember-orange font-medium mb-4">
						Interconnected worlds of supernatural romance
					</p>
					<p class="text-lg text-moon-silver/90 max-w-3xl mx-auto leading-relaxed">
						Dive deep into rich universes where every book builds on the last, following beloved characters across multiple adventures in paranormal romance and urban fantasy.
					</p>
				</div>
			</div>
		</section>

		<!-- Series Showcase -->
		{sortedSeries.map((series, index) => (
			<section class={`py-16 ${index % 2 === 0 ? 'bg-dark-surface' : 'bg-bg-secondary'}`}>
				<div class="container mx-auto px-4">
					<div class="max-w-7xl mx-auto">
						<!-- Series Header -->
						<div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
							<!-- Series Info -->
							<div class={`space-y-6 ${index % 2 === 1 ? 'lg:order-2' : ''}`}>
								<div class="space-y-4">
									<div class="flex flex-wrap items-center gap-4">
										<h2 class="text-3xl md:text-4xl font-primary font-bold text-bone-white">
											{series.data.title}
										</h2>
										{series.data.completionStatus === 'complete' && (
											<span class="badge badge-primary uppercase tracking-wide">
												Complete
											</span>
										)}
										{series.data.completionStatus === 'ongoing' && (
											<span class="badge badge-secondary uppercase tracking-wide">
												Ongoing
											</span>
										)}
									</div>

									<div class="flex flex-wrap items-center gap-6 text-lg text-fog-gray">
										<span class="flex items-center gap-2">
											<svg class="w-5 h-5 text-ember-orange" fill="currentColor" viewBox="0 0 20 20">
												<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
											</svg>
											<span class="font-medium">{series.data.bookCount} Books</span>
										</span>
										{series.data.overallRating && (
											<span class="flex items-center gap-2">
												<svg class="w-5 h-5 text-ember-orange" fill="currentColor" viewBox="0 0 20 20">
													<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
												</svg>
												<span class="font-medium">{series.data.overallRating} ({series.data.totalRatings?.toLocaleString()} ratings)</span>
											</span>
										)}
									</div>
								</div>

								<p class="text-lg text-moon-silver leading-relaxed">
									{series.data.description}
								</p>

								{series.data.worldBuilding && (
									<p class="text-base text-fog-gray italic border-l-4 border-ember-orange pl-4">
										{series.data.worldBuilding}
									</p>
								)}

								{(() => {
									const currentSpecies = series.data.species || [];
									return currentSpecies.length > 0 && (
										<div class="space-y-3">
											<h4 class="text-lg font-semibold text-bone-white">Featured Creatures:</h4>
											<div class="flex flex-wrap gap-3">
												{currentSpecies.map((species: string) => (
													<a
														href={`/species/${species}`}
														class="px-4 py-2 bg-mystic-violet/80 text-bone-white rounded-lg text-sm font-medium shadow-lg hover:bg-ember-orange hover:text-shadow-black transition-colors duration-200"
													>
														{formatSpeciesName(species)}
													</a>
												))}
											</div>
										</div>
									);
								})()}

								<div class="flex flex-col sm:flex-row gap-4 pt-4">
									<a
										href={`/series/${series.slug}`}
										class="btn btn-primary btn-lg"
									>
										Explore Series
									</a>
									{series.books.length > 0 && (
										<a
											href={`/books/${series.books[0].slug}`}
											class="btn btn-outline btn-lg"
										>
											Start Reading
										</a>
									)}
								</div>
							</div>

							<!-- Book Stack Visualization -->
							<div class={`relative ${index % 2 === 1 ? 'lg:order-1' : ''}`}>
								<div class="relative w-full max-w-sm mx-auto">
									<!-- Base container to establish dimensions -->
									<div class="relative aspect-[2/3] w-full">
										<!-- Create stacked book effect -->
										{series.books.slice(0, 4).map((book, bookIndex) => (
											<div
												class="absolute top-0 left-0 w-full h-full transition-transform duration-300 hover:scale-105 hover:z-20"
												style={{
													transform: `rotate(${(bookIndex - 1.5) * 3}deg) translate(${bookIndex * 8}px, ${bookIndex * 4}px)`,
													zIndex: 4 - bookIndex
												}}
											>
												{/* Book cover placeholder */}
												<div class="w-full h-full bg-gradient-to-br from-mystic-violet/40 to-midnight-purple rounded-xl shadow-2xl flex items-center justify-center border border-mystic-violet/50 transition-all duration-300 hover:border-ember-orange/70 hover:shadow-mystic">
													<div class="text-center text-moon-silver p-4">
														<div class="text-5xl mb-3 opacity-70">ðŸ“–</div>
														<div class="text-sm font-bold text-bone-white line-clamp-2">{book.data.title}</div>
														<div class="text-xs text-ember-orange mt-1">Book {book.data.seriesOrder}</div>
													</div>
												</div>

												<!-- Book info overlay on hover -->
												<div class="absolute inset-0 bg-shadow-black/95 opacity-0 hover:opacity-100 transition-opacity duration-300 rounded-xl flex items-center justify-center p-4">
													<div class="text-center text-bone-white">
														<h4 class="text-base font-bold mb-2 line-clamp-2">{book.data.title}</h4>
														<p class="text-sm text-ember-orange mb-3">Book #{book.data.seriesOrder}</p>
														<a
															href={`/books/${book.slug}`}
															class="btn btn-primary btn-sm text-sm"
														>
															View Book
														</a>
													</div>
												</div>
											</div>
										))}

										{/* Add book count indicator if more than 4 books */}
										{series.books.length > 4 && (
											<div class="absolute -bottom-3 -right-3 bg-ember-orange text-shadow-black rounded-full w-12 h-12 flex items-center justify-center font-bold text-sm shadow-lg z-30">
												+{series.books.length - 4}
											</div>
										)}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		))}

		<!-- Browse Books CTA -->
		<section class="py-16 bg-gradient-to-r from-midnight-purple via-shadow-black to-midnight-purple">
			<div class="container mx-auto px-4 text-center">
				<div class="max-w-3xl mx-auto">
					<h2 class="text-3xl md:text-4xl font-primary font-bold text-bone-white mb-6">
						Ready to Start Reading?
					</h2>
					<p class="text-lg text-moon-silver/90 mb-8">
						Browse all books to find the perfect starting point for your supernatural romance journey
					</p>
					<a href="/books" class="btn btn-primary btn-lg">
						Browse All Books
					</a>
				</div>
			</div>
		</section>
	</main>
</Layout>

<style>
	/* Custom 3D effects for the book stacking */
	.shadow-3xl {
		box-shadow: 0 35px 60px -12px rgba(0, 0, 0, 0.5);
	}
</style>
